\section{Problemy konstrukcyjne}
\label{sec:problemy_konstrukcyjne}
    W poniższym rozdziale zostaną przedstawione problemy konstrukcyjne,
    które pojawiły się podczas realizacji projektu.

    \subsection{Jazda prosto}
    \label{section:jazda_prosto}
        Najprostszą czynnością każdego pojazdu jest jazda prosto.
        Operacja ta może wydawać się łatwa jednak wcale taka nie jest.
        Przykładowo kiedy usiądziemy za kierownicą, prawdziwego samochodu kontroluje podświadomie wiele parametrów takich jak:
        \begin{itemize}
            \item nachylenie terenu,
            \item aktualną pozycję kół,
            \item linie poziome na drodze czy pobocze drogi.
        \end{itemize}
        Jako ludzie wiele tych parametrów kontroluje ,,na wyczucie'' jednak pojazdy autonomiczne, są poniekąd robotami, które nie mogą polegać na ,,uczuciu'', że jadą prosto.
        Dlatego koniecznym jest zastosowanie odpowiednich czujników, które pozwolą na dokładną kontrolę jazdy.
        W poniższym rozdziale pokrótce zostaną opisane rozwiązanie dzięki którym samochód jest w stanie jeździć w sposób powtarzalny.

        \subsubsection{Różnica prędkości silników}
            Zastosowanie dwóch silników ma swoje wady i zalety.
            Niewątpliwą zaletą jest podwojenie mocy pojazdu.
            Jednak olbrzymią wadą okazało się sterowanie i nierównomierność pracy silników.
            Na wykresie \ref{plot:distance_err_in_time_const_speed} poniżej przedstawiono różnicę drogi pokonanej przez każdy silnik dla jednakowego sygnału sterującego.

            \begin{figure}[!ht]
                \centering
                \begin{tikzpicture}
                    \begin{axis}[
                        width = 0.7\textwidth,
                        grid = both,
                        grid style = dashed,
                        % axis lines = middle,
                        xlabel = czas ${[s]}$,
                        ylabel = różnica odległości ${[mm]}$,
                        xmin = 0,
                        xmax = 20,
                    ]
                        \addplot[blue] table[x = Time, y = Diff, col sep = comma]{Measure/distance_no_PID_speed_50.csv};
                        \legend{Błąd odległości}
                    \end{axis}
                \end{tikzpicture}
                \caption{Wykres różnicy przebytej drogi między prawym a lewym silnikiem bez regulacji}
                \label{plot:distance_err_in_time_const_speed}
            \end{figure}

            Aby rozwiązać powyższy problem należy zastosować regulator PID pozwalający w trakcie pracy, korygować prędkość silników.
            Natomiast podczas startu silników została zastosowana sztywna korekta prędkości w celu zminimalizowania błędu.
            \begin{figure}[!ht]
                \centering
                \begin{tikzpicture}
                    \begin{axis}[
                        width = 0.7\textwidth,
                        grid = both,
                        grid style = dashed,
                        xlabel = czas ${[s]}$,
                        ylabel = różnica odległości ${[mm]}$,
                        xmin = 0,
                        xmax = 60,
                    ]
                        \addplot[blue] table[x = Time, y = Distance_err, col sep = comma]{Measure/PID_speed_10.csv};
                        \legend{Błąd odległości}
                    \end{axis}
                \end{tikzpicture}
                \caption{Wykres różnicy przebytej drogi między prawym a lewym silnikiem z włączonym regulatorem PID. Prędkość pojazdu: $(35.10 \pm 0.10)\frac{mm}{s}$.}
                \label{plot:PID_distance_err_in_time}
            \end{figure}

            Jak widać na wykresie \ref{plot:PID_distance_err_in_time} w początkowej fazie, silniki nadal nie pracują równomiernie, w dłuższej perspektywie praca silników osypuje w okół stałej wartości $(0 \pm 3)mm$.

    \subsubsection{Nieidealność podwozia}
        Kolejnym napotkanym problemem, okazuje się nieidealność podwozia.
        Szczególnie elementu przedstawionego na rysunku \ref{fig:frontAxis_model} oraz nierównomierne rozłożenie masy względem środka.
        Wszystkie wyżej wymienione niedokładności powodowały, że pojazd cały czas skręcał w jedną stronę.
        Rozwiązaniem tego problemu jest zastosowanie pętli sprzężenia zwrotnego, opartej na czujniku $MPU6050$, który został użyty jak żyroskop, pozwalający na pomiar biedzącego kąta.
        Dzięki czemu można korygować kierunek skręcania pojazdu.

        Jednak jego wykorzystanie nie było bezproblemowe i wymagało dodatkowych poprawek.
        Na wykresie \ref{plot:gyro_magneto_measure} przedstawiono pomiar kąta dla obrotu pojazdu ze stałą prędkością w jednym kierunku po kalibracji czujnika.
        Poniższy pomiar został wykonany w celu ustalenia liniowości pracy żyroskopu opartego na akcelerometrze.
        Układem referencyjnym był uprzednio skalibrowany magnetometr (układ $QMC5883L$).
%
        \begin{figure}[!ht]
            \centering
                \begin{tikzpicture}
                    \begin{axis}[
                        width = 0.65\textwidth,
                        grid = both,
                        grid style = dashed,
                        xlabel = czas ${[s]}$,
                        ylabel = kąt zmierzony podczas obrotu ${[^\circ]}$,
                        ymin = -5,
                        ymax = 365,
                        xmin = 0,
                        xmax = 2.9,
                        ytick = {0, 30, ..., 360},
                        legend style={at={(0.2, 0.92)}, anchor=north},
                    ]
                        \addplot[orange] table[x = Time, y = Compass_azimuth, col sep = comma]{Measure/angles.csv};
                        \addplot[blue] table[x = Time, y = Gyro_z, col sep = comma]{Measure/angles.csv};
                        \legend{magnetometr,żyroskop}
                    \end{axis}
                \end{tikzpicture}
                \caption{Wykres pomiary azymutu za pomocą magnetometru oraz zmiany kąta wykazanego przez żyroskop}
                \label{plot:gyro_magneto_measure}
        \end{figure}
        Podczas pomiaru, na oba układy został nałożony filtr dolnoprzepustowy, eliminujący szumy.

        Wykres \ref{plot:delta_angle_with_gyro} przedstawia narastanie katą, mierzonego przez żyroskop.
        Widać bardzo dużą liniowość pracy żyroskopu, co pozwala zaufać temu czujnikowi na tyle, aby na jego podstawie określać czy pojazd jedzie prosto.

        % \begin{wrapfig}[!ht]
        \begin{figure}[!ht]
            \centering
                \begin{tikzpicture}
                    \begin{axis}[
                        width = 0.7\textwidth,
                        grid = both,
                        grid style = dashed,
                        xlabel = czas ${[s]}$,
                        ylabel = kąt zmierzony podczas obrotu ${[^\circ]}$,
                        xmin = 0,
                        xmax = 2.9,
                    ]
                        \addplot[blue] table[x = Time, y = Delta_angle, col sep = comma]{Measure/angles.csv};
                    \end{axis}
                \end{tikzpicture}
                \caption{Wykres narastania kąta, zmierzonego przez żyroskop}
                \label{plot:delta_angle_with_gyro}
        \end{figure}
        % \end{wrapfig}


% \newpage
    Oba wyżej opisane rozwiązania pozwalają na w miarę stałą jazdę prostą ($\pm 2^\circ$).
    A w sytuacjach, kiedy pojazd zaczyna znacząco skręcać na przykład po impakcie z boku, sprzężenie zwrotne z żyroskopu pozwala wykryć znaczącą zmianę kąta ruchu.
    Kolejny regulator PID odczytuje wartość kąta i koryguje kąt serwomechanizmu tak aby pojazd wrócił na prostą.

    \subsection{Skręcanie}
        Rozwiązanie problemów z jazdą prosto to tylko połowa sukcesu.
        Kolejne mankamenty wyszły podczas próby skręcania.
        Nie tylko w pierwotnej wersji nie było stałe - ustawienie stałego kąta kół oraz przejechanie tej samej drogi nie zawsze dawało ten sam rezultat.
        To pojazd cały czas miał tendencję do preferowania skrętu w jedną stronę.

        \subsubsection{Dyferencjał}
        \label{subsubsec:dyferencjal}
        Najprostszym do zauważenia problemem był brak dyferencjału.
        Tylna oś pojazdu posiada dwa silniki jednak w poprzednich testach, zostały one ,,software'owo połączona sztywną belką".
        Powodowało to poślizg pojazdu podczas skręcania a w konsekwencji uniemożliwiało powtarzalność manewru.

        Rozwiązaniem tego problemu jest zmiana prędkości pracy silników w zależności od promienia skrętu.
        Poniżej przedstawiono schemat algorytmu, na którego podstawie wyznaczono procentową wartość dyferencjału.
        Rysunek \ref{draw:turning_car} przedstawia schematyczną sytuację skręcania.
        \input{Schematic/turning.tex}

        Jak widać skręt pojazdu można opisać jako ruch dwóch kół po okręgach o wspólnym środku, w których poszczególne prędkości liniowe nie są sobie równe.
        Jednak występuje zależność:
        \begin{gather}
            \omega_{\text{wewnęrznego koła}} = \omega_{\text{zewnętrznego koła}}\\
            \frac{v_{\text{wewnęrznego koła}}}{r} = \frac{v_{\text{zewnętrznego koła}}}{r + \Delta r}\\
            \frac{v_\text{wewnęrznego koła}}{v_{\text{zewnętrznego koła}}} = \frac{r}{r + \Delta r}
        \end{gather}

        Aby policzyć zależność między prędkościami silników, należy wyznaczyć promień skrętu.
        Do tego celu, można wykorzystać znane wartości i równanie \ref{eq:turning_radius}.
        Znanymi wartościami są:
        \begin{gather}
            \tan \left(90 - \gamma\right) = \frac{l}{r}\\
            r(\gamma) = \frac{l}{\tan(90-\gamma)}
            \label{eq:turning_radius}
        \end{gather}

        Gdzie:
        \begin{itemize}
            \item $l = 155$ -- długość między osiami samochodu:,
            \item $\Delta r = 125$ -- odległość między kołami w jednej osi,
            \item $\gamma \in <60^\circ \div 120^\circ>$ -- kąt skrętu kół, ustawiany przez algorytm nawigacji lub użytkownika.
        \end{itemize}

        A zatem procentowy stosunek prędkości w funkcji kąta można wyrazić jako:
        \begin{gather}
            \frac{v_{\text{prawe koła}}}{v_{\text{lewe koła}}} = 1 + \frac{\Delta r}{r} = 1 + \Delta r \cdot \frac{\tan(90 - \gamma)}{l}
        \end{gather}


        \subsection{Nierównomierność skrętu}
        \label{subsec:nierownomiernosc_skretu}
            W trakcie testów, okazało się że pojazd nie skręca równomiernie w obie strony.
%
            Podczas manewrów w prawo, na łuku o długości $s = 500mm$, pojazd zakreślał kąt około $70^\circ$.
            Natomiast na tym samym odcinku ale w lewo zakreślany kąt to około $50^\circ$.

            Wymusiło ustawienie wartości offsetu, przesuwającej wartość kąta skrętu.
            Jego wartość została wyznaczona eksperymentalnie i wynosiła około $-6^\circ$.
            Dla podanej wartości kąt zakreślany podczas skrecania w obu kierunkach wynosił około $60^\circ$.



    Dzięki wszystkim wyżej wymiennym zabiegom udało się uzyskać powtarzalne wyniki zarówno podczas jazdy prosto, cofania się oraz skręcania.
    Powyższe działania są niezbędne, jeśli budowany robot ma być sterowany autonomicznie.

